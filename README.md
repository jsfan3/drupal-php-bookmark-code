# PHP Bookmark Code (CKEditor compatible)

**PHP Bookmark Code** is an experimental Drupal 10 module that allows administrators to create bookmarks (or placeholders) associated with custom PHP code blocks. Once configured, these bookmarks can be inserted into content (articles, pages, etc.) where no PHP is directly embedded. During the rendering process, the module’s text filter will detect bookmark placeholders (e.g., `[bookmark:example]`) and replace them with the output generated by executing the corresponding PHP code.

> **WARNING:** Executing arbitrary PHP code is extremely dangerous. Always ensure that only trusted administrators can manage bookmark code blocks. This module is experimental and intended for controlled environments.

## Overview

- **Admin UI:** Under *Configuration → System → PHP Bookmark Code*, administrators can add, edit, and enable/disable bookmark code blocks. Each block consists of a unique bookmark identifier (used in content), a title, and the PHP code to execute.
- **Text Filter:** A custom text filter scans for bookmark placeholders in content and replaces them with the output produced by executing the PHP code. The code is executed exactly where the placeholder appears during page rendering.
- **Use Cases:**  
  - Insert dynamic content (such as data from a database, API responses, etc.) into otherwise static articles.
  - Centralize and manage PHP logic without embedding PHP directly into content.
  - Similar to the shortcodes approach used in WordPress, but with the added flexibility of executing PHP code.

## How It Works

1. **Bookmark Creation:**  
   Administrators create bookmark code blocks via the admin UI. Each block is given a unique identifier (e.g., `example`) and associated PHP code. The PHP code is stored in a custom database table.

2. **Content Processing:**  
   The module registers a text filter that looks for placeholders in the format `[bookmark:identifier]`. When such a placeholder is found, the module retrieves the corresponding PHP code, executes it (using `eval()` with output buffering), and replaces the placeholder with the resulting output.

3. **Dynamic Execution:**  
   Since the filter processes content during rendering, the PHP code output is inserted exactly where the bookmark appears. This allows for dynamic content generation in any part of an article or page.

## Installation

### Via Composer

Add the GitHub repository as a VCS repository in your project’s `composer.json`:

```json
{
  "repositories": [
    {
      "type": "vcs",
      "url": "https://github.com/jsfan3/drupal-php-bookmark-code"
    }
  ]
}
```

Then require the package:

```bash
composer require jsfan3/php-bookmark-code:dev-main
```

After that, you can always upgrade the module to the latest version:

```bash
composer update jsfan3/php-bookmark-code
```

### Enabling the Module

Enable the module using Drush or via the Drupal Extend UI:

```bash
drush en php_bookmark_code -y
```
### Adding the filter

To integrate PHP Bookmark Code with your content, you need to enable the PHP Bookmark Filter for your text format. Follow these steps:

1. **Navigate to Text Formats and Editors:**
   - Go to **Configuration → Content Authoring → Text Formats and Editors** in your Drupal admin interface.

2. **Edit Your Desired Text Format:**
   - Choose the text format you want to use with PHP Bookmark Code (for example, "Full HTML" or a custom format).

3. **Enable the PHP Bookmark Filter:**
   - In the list of available filters, locate **PHP Bookmark Filter**.
   - Check the box to enable it.

4. **Adjust the Filter Order (if needed):**
   - Ensure that the PHP Bookmark Filter is positioned appropriately in the filter processing order. For instance, place it after any filters that modify basic markup to guarantee that bookmark placeholders (e.g., `[bookmark:example]`) are correctly detected and replaced during rendering.

5. **Save the Configuration:**
   - Click **Save configuration** to apply your changes.
  
> **Note:** The PHP Bookmark Filter is fully compatible with CKEditor 5. After enabling the filter, ensure that your text format’s allowed HTML elements are properly configured so that CKEditor displays the complete toolbar and functions as expected.

With these steps completed, any content containing bookmark placeholders will be processed by the PHP Bookmark Filter, which executes the associated PHP code and replaces the placeholders with the generated output. 

### Configure the Module

Navigate to **Configuration → System → PHP Bookmark Code** to add and manage your bookmark code blocks.

## Usage Examples

### Example 1: Inserting a Utility Function Output  
1. Create a bookmark code block with the bookmark identifier `greet` and PHP code such as:
   ```php
   echo "Hello, welcome to our site!";
   ```
2. In your article, insert the placeholder `[bookmark:greet]`.
3. When the page is rendered, the placeholder is replaced with "Hello, welcome to our site!".

### Example 2: Dynamic Data Retrieval

Suppose you want to display the total number of registered users in your Drupal site within an article. Follow these steps:

1. **Create a Bookmark Code Block:**

   - **Bookmark Identifier:** `user_count`
   - **Title:** `User Count`
   - **PHP Code:**  
     ```php
     // Query the standard Drupal user table to count the total number of registered users.
     $query = \Drupal::database()->select('users_field_data', 'u');
     // Count all user IDs.
     $query->addExpression('COUNT(uid)', 'count');
     $user_count = $query->execute()->fetchField();
     
     // Output the user count.
     echo "Total registered users: " . $user_count;
     ```
   - **Ensure the block is enabled.**

2. **Insert the Bookmark in Content:**

   In your article (or any content that does not contain PHP directly), insert the following placeholder exactly where you want the output to appear:
   ```
   [bookmark:user_count]
   ```

3. **Result on the Rendered Page:**

   When the page is rendered, the module’s text filter will detect the `[bookmark:user_count]` placeholder, execute the associated PHP code, and replace the placeholder with the output. For example, if there are 10 registered users, the rendered page will display:
   ```
   Total registered users: 10
   ```


## Caveats and Warnings

- **Security:** The module uses `eval()` to execute PHP code. Ensure that only trusted users have permission to manage bookmark code blocks.
- **Error Handling:** The execution of PHP code is wrapped with output buffering and a try/catch block. However, syntax errors will not be caught and can cause fatal errors.
- **Experimental:** This module is experimental and intended for controlled testing environments. Use it with caution.

## Conclusion

**PHP Bookmark Code** provides a flexible solution to insert dynamic PHP-generated content into static articles without embedding PHP directly into the content. It is especially useful for prototyping and for cases where dynamic content needs to be inserted via simple placeholders. However, for production environments, consider building more robust solutions with dedicated custom modules and secure API integrations.
